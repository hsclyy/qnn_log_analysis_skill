# README 文档设计

## 设计目标

为 QNN 日志分析技能项目创建一份清晰、专业且易于理解的 README 文档，帮助开发者快速了解项目功能、安装配置和使用方式。

## 目标受众

- 使用 Qualcomm QNN SDK 的嵌入式开发者
- AI 模型部署工程师
- 系统集成测试人员
- 对 QNN 运行时错误诊断感兴趣的技术人员

## 文档结构规划

### 第一部分：项目概述

**目的**：快速向读者传达项目的核心价值和应用场景

**内容要点**：
- 项目简介：说明这是一个智能化的 QNN 日志分析工具
- 核心功能：自动识别 QNN SDK 运行时错误的根本原因并提供解决方案
- 技术特色：基于 LLM 和知识库的智能分析系统
- 应用场景：适用于在高通 SoC 上部署神经网络模型时的故障排查

**表达策略**：
- 使用简洁的语言突出"自动化"和"智能化"特性
- 强调能够解决的实际痛点（减少人工日志分析时间）
- 提及支持的后端类型（CPU、GPU、HTP）

### 第二部分：功能特性

**目的**：详细说明系统的核心能力

**功能列表**：

| 功能模块 | 功能描述 | 技术实现要点 |
|---------|---------|------------|
| 日志特征提取 | 自动识别日志中的后端类型和错误模式 | 基于关键字匹配的轻量级解析器 |
| 智能知识库选择 | 根据日志特征动态加载相关知识文档 | 条件判断逻辑，按需加载 overview、errors、sop |
| 结构化提示词构建 | 将日志和知识整合为高质量的 LLM 输入 | 模板化设计，包含规则约束和输出格式要求 |
| LLM 智能分析 | 调用大语言模型进行根因分析 | 使用 OpenAI GPT-4o-mini，低温度参数确保稳定性 |
| 结构化结果输出 | 返回根本原因、解决方案和置信度 | JSON 格式，包含防御式解析机制 |

**功能流程图**：

通过 Mermaid 图展示完整的分析流程：

```
输入日志 → 特征提取 → 知识库选择 → 提示词构建 → LLM 调用 → 结果解析 → 输出结果
```

每个环节的输入输出明确定义，展示数据流转过程。

### 第三部分：项目结构

**目的**：帮助读者快速理解代码组织方式

**目录结构说明**：

采用树形结构展示项目文件：
- 根目录层：核心 Python 模块（skill.py、prompt.py、example.py）
- knowledge/ 目录：知识库文件（overview.md、errors.md、sop.md）

**各文件职责说明**：

| 文件名 | 职责 | 关键接口 |
|--------|------|---------|
| skill.py | 主控制器，协调整个分析流程 | analyze_log_skill(log_text) |
| prompt.py | 提示词构建器，整合知识和日志 | build_prompt(log_text, knowledge) |
| example.py | 示例代码，展示三种典型错误场景 | 包含设备创建、图创建、推理执行失败案例 |
| knowledge/overview.md | QNN SDK 基础知识 | 介绍后端类型和典型运行流程 |
| knowledge/errors.md | 错误知识库 | 按错误码和阶段分类的诊断方案 |
| knowledge/sop.md | 标准操作程序 | 五步诊断法指引 |

**组件交互关系**：

使用 Mermaid 图展示模块间的依赖和调用关系：
- example.py 调用 skill.py
- skill.py 依赖 prompt.py 和 OpenAI API
- skill.py 读取 knowledge/ 目录下的知识文件
- prompt.py 负责整合知识内容

### 第四部分：快速开始

**目的**：让用户能在 5 分钟内运行起来

**前置要求**：

| 依赖项 | 版本要求 | 说明 |
|--------|---------|------|
| Python | 3.7+ | 推荐 3.8 或更高版本 |
| openai | 最新稳定版 | 用于调用 OpenAI API |
| OpenAI API Key | - | 需要有效的 API 密钥 |

**安装步骤**：

1. 克隆或下载项目代码
2. 安装依赖包（通过 pip install openai）
3. 配置 API 密钥（在 skill.py 中设置）

每个步骤提供清晰的命令示例或配置说明。

**快速运行**：

提供一条命令直接运行示例代码：
```
python example.py
```

说明预期输出：会看到三个日志案例的分析结果，每个结果包含根本原因、解决方案列表和置信度。

### 第五部分：使用指南

**目的**：说明如何在实际项目中集成使用

**基本用法**：

展示最简单的代码调用示例：
- 导入 analyze_log_skill 函数
- 准备日志文本
- 调用函数并获取结果
- 解析返回的 JSON 结构

**输入格式说明**：

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| log_text | 字符串 | QNN 运行时日志内容 | 包含 ERROR、INFO 等级别的完整日志 |

**输出格式说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| root_cause | 字符串 | 错误的根本原因分析 |
| solutions | 字符串数组 | 按优先级排序的解决方案列表 |
| confidence | 浮点数 | 分析结果的置信度（0.0-1.0） |

**典型应用场景**：

场景一：设备初始化失败
- 日志特征：qnn_htp_device_create failed
- 错误码：QNN_STATUS_MEMORY_ALLOCATION_FAILED
- 分析结果：HTP 固件内存碎片化或系统堆不足
- 建议方案：清理旧上下文、重启设备、检查内存压力

场景二：图创建失败
- 日志特征：qnn_graph_create failed
- 错误码：QNN_STATUS_MEMORY_ALLOCATION_FAILED
- 分析结果：图张量数量超过 HTP 容量
- 建议方案：启用图分割、降低输入分辨率、算子融合

场景三：推理执行失败
- 日志特征：qnn_execute_graph failed
- 错误码：QNN_STATUS_MEMORY_ALLOCATION_FAILED
- 分析结果：运行时激活缓冲区超过 HTP 内存
- 建议方案：固定输入形状、减少并发会话、使用低精度

### 第六部分：技术架构

**目的**：为希望深入了解或二次开发的用户提供技术细节

**架构设计理念**：

- 分层架构：将接口层、业务逻辑层、提示词层、知识库层清晰分离
- 模块化设计：每个模块职责单一，易于测试和维护
- 知识驱动：通过外部知识文件驱动诊断逻辑，便于扩展
- LLM 集成：利用大语言模型的语义理解能力进行智能分析

**核心组件说明**：

| 组件名称 | 设计模式 | 核心职责 |
|---------|---------|---------|
| analyze_log_skill | 门面模式 | 统一对外接口，协调各组件 |
| parse_log | 策略模式 | 可扩展的特征提取策略 |
| select_knowledge | 工厂模式 | 根据特征动态选择知识 |
| build_prompt | 建造者模式 | 构建结构化提示词 |
| call_llm | 适配器模式 | 封装 OpenAI API 调用 |

**数据流转说明**：

通过序列图展示完整的数据流：
1. 用户调用 analyze_log_skill 并传入日志文本
2. 系统提取特征（后端类型、错误标志）
3. 根据特征加载对应知识文件
4. 构建包含规则、知识、日志的提示词
5. 调用 LLM 并获取 JSON 响应
6. 解析并返回结构化结果

**技术决策说明**：

| 决策点 | 选择方案 | 理由 |
|--------|---------|------|
| LLM 模型 | GPT-4o-mini | 成本低、响应快、准确度满足需求 |
| 温度参数 | 0.1 | 日志分析需要确定性强的结果 |
| 知识存储 | Markdown 文件 | 易于编辑维护，便于版本控制 |
| 特征提取 | 关键字匹配 | 轻量级，无需复杂的正则表达式 |
| JSON 解析 | 防御式解析 | 防止 LLM 输出格式异常导致系统崩溃 |

### 第七部分：知识库说明

**目的**：指导用户如何维护和扩展知识库

**知识库结构**：

overview.md - 基础知识
- 内容范围：QNN SDK 简介、后端类型、典型流程
- 维护原则：保持简洁，聚焦运行时背景
- 更新频率：随 SDK 大版本更新

errors.md - 错误知识库
- 组织方式：按错误码分节，每个错误码按阶段细分
- 条目结构：典型日志 + 根本原因 + 解决方案
- 维护原则：确保错误码命名一致、阶段描述准确、方案可操作
- 扩展方式：遇到新错误类型时添加新章节

sop.md - 标准操作程序
- 内容：五步诊断法流程
- 步骤：识别后端 → 提取错误码 → 定位阶段 → 应用方案 → 记录新案例
- 维护原则：保持流程清晰可执行

**知识库扩展指南**：

添加新错误类型的步骤：
1. 收集典型日志样本
2. 分析根本原因
3. 验证解决方案有效性
4. 在 errors.md 中添加新章节
5. 更新 parse_log 函数以识别新特征（如需要）
6. 测试分析准确性

**知识库质量标准**：

| 质量维度 | 评估标准 |
|---------|---------|
| 准确性 | 根因分析基于官方文档或实测验证 |
| 完整性 | 覆盖常见的 QNN 运行时错误场景 |
| 可操作性 | 解决方案具体明确，可直接执行 |
| 一致性 | 术语、格式、结构保持统一 |
| 时效性 | 与当前 QNN SDK 版本保持同步 |

### 第八部分：配置说明

**目的**：指导用户正确配置系统参数

**必需配置项**：

| 配置项 | 位置 | 说明 | 示例 |
|--------|------|------|------|
| OpenAI API Key | skill.py 第 6 行 | 用于调用 OpenAI 服务 | sk-xxxxxxxxxxxxxxxx |

**可选配置项**：

| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| LLM 模型 | skill.py call_llm 函数 | gpt-4o-mini | 可更换为其他 OpenAI 模型 |
| 温度参数 | skill.py call_llm 函数 | 0.1 | 控制输出随机性，建议保持低值 |
| 知识库路径 | skill.py select_knowledge 函数 | knowledge/ | 可指定自定义知识库位置 |
| 系统提示词 | skill.py SYSTEM_PROMPT | 预定义规则 | 可根据需求调整约束规则 |

**配置建议**：

针对不同使用场景的配置推荐：
- 生产环境：保持默认配置，确保稳定性
- 开发测试：可提高温度参数观察多样性
- 离线环境：需替换为本地 LLM 服务
- 定制场景：扩展知识库并调整特征提取逻辑

### 第九部分：常见问题

**目的**：预先解答用户可能遇到的问题

**安装和配置类问题**：

问题：ModuleNotFoundError: No module named 'openai'
- 原因：未安装 openai 依赖包
- 解决方法：执行 pip install openai 安装

问题：API 调用失败，提示认证错误
- 原因：API Key 未配置或无效
- 解决方法：检查 skill.py 中的 API Key 配置是否正确

问题：知识库文件读取失败
- 原因：运行目录不正确或文件路径错误
- 解决方法：确保在项目根目录运行，检查 knowledge/ 目录是否存在

**使用类问题**：

问题：分析结果置信度很低
- 原因：日志信息不完整或错误类型不在知识库中
- 解决方法：补充完整日志，或扩展知识库添加新错误类型

问题：返回的是 raw_output 而不是结构化结果
- 原因：LLM 输出格式不符合 JSON 规范
- 解决方法：检查系统提示词约束，或调整温度参数

问题：分析速度较慢
- 原因：网络延迟或 API 响应时间
- 解决方法：考虑使用缓存机制或本地 LLM 部署

**扩展类问题**：

问题：如何支持新的错误码
- 解决方法：在 errors.md 中添加新条目，更新特征提取逻辑

问题：如何更换为其他 LLM 服务
- 解决方法：修改 call_llm 函数，适配新的 API 接口

问题：如何添加日志预处理逻辑
- 解决方法：在 parse_log 函数中扩展特征提取规则

### 第十部分：最佳实践

**目的**：提供使用建议和优化方向

**日志准备建议**：

- 完整性：提供从初始化到失败的完整日志链
- 上下文：包含足够的 INFO 级别日志辅助定位
- 格式：保持原始日志格式，不要过度裁剪
- 敏感信息：移除涉及隐私的路径或配置信息

**知识库维护建议**：

- 定期更新：跟随 QNN SDK 版本更新知识内容
- 案例积累：将实际遇到的新错误及时补充
- 质量审查：定期验证解决方案的有效性
- 版本管理：使用 Git 跟踪知识库变更历史

**性能优化建议**：

| 优化方向 | 实现方式 | 预期收益 |
|---------|---------|---------|
| 减少 API 调用 | 实现结果缓存机制 | 降低成本和延迟 |
| 知识库预加载 | 启动时加载到内存 | 减少文件 I/O |
| 批量分析 | 支持多日志并发处理 | 提高吞吐量 |
| 本地模型 | 部署私有 LLM 服务 | 提升响应速度和数据安全 |

**集成建议**：

- CI/CD 集成：作为自动化测试流程的一部分
- 监控系统集成：实时分析生产环境日志
- 告警系统集成：根据分析结果自动触发告警
- 知识管理系统集成：将诊断结果沉淀为知识库

### 第十一部分：贡献指南

**目的**：鼓励开源社区参与改进

**如何贡献**：

贡献类型：
- 补充新的错误案例和解决方案
- 改进代码质量和性能
- 完善文档和注释
- 报告 Bug 和提出改进建议

**贡献流程**：

1. Fork 项目仓库
2. 创建特性分支
3. 提交代码或文档变更
4. 确保变更符合项目规范
5. 提交 Pull Request 并描述变更内容

**代码规范**：

- Python 代码遵循 PEP 8 风格指南
- 函数添加清晰的文档字符串
- 关键逻辑添加注释说明
- 提交信息使用清晰的描述

**知识库贡献规范**：

- 新增错误条目遵循现有模板结构
- 提供真实可复现的日志样本
- 解决方案需经过实际验证
- 保持术语和格式一致性

### 第十二部分：许可证和联系方式

**目的**：明确项目的使用许可和支持渠道

**许可证说明**：

- 说明项目采用的开源许可证类型
- 阐述使用和修改的权利范围
- 提醒商业使用的注意事项

**联系方式**：

- 项目主页或代码仓库地址
- Issue 提交渠道
- 技术交流群组或论坛
- 维护者联系方式

**致谢**：

- 感谢使用的开源项目和工具
- 感谢贡献者的参与
- 感谢相关技术社区的支持

## 文档编写原则

### 语言风格

- 使用清晰、简洁的技术语言
- 避免过度营销化的表达
- 专业术语给出必要的解释
- 中英文混排时注意空格和标点

### 内容组织

- 从简单到复杂的渐进式结构
- 重要信息前置，细节后置
- 使用列表、表格提高可读性
- 适当使用图表辅助理解

### 示例代码

- 使用 Markdown 代码块，注明语言类型
- 示例代码简洁明了，突出重点
- 避免展示实际的 API Key 等敏感信息
- 提供预期输出或运行结果

### 视觉元素

- 使用 Mermaid 图表展示架构和流程
- 使用表格整理结构化信息
- 使用适当的标题层级划分章节
- 使用引用块突出重要提示

## 文档质量标准

### 完整性

- 覆盖安装、配置、使用、维护全流程
- 包含常见问题的解答
- 提供足够的示例和参考

### 准确性

- 技术描述与实际代码一致
- 命令和配置经过验证
- 版本信息保持更新

### 易用性

- 新用户能快速上手
- 高级用户能找到深入信息
- 结构清晰，便于查找

### 维护性

- 模块化组织便于更新
- 版本变更时易于定位修改点
- 遵循一致的格式和风格

## 后续维护计划

### 版本同步

- 代码功能更新时同步更新文档
- 新增功能及时补充使用说明
- API 变更及时反映在文档中

### 用户反馈

- 收集用户在使用中遇到的问题
- 根据反馈完善常见问题章节
- 优化文档结构和表达方式

### 持续改进

- 定期审查文档质量
- 补充更多实际案例
- 优化图表和可视化效果
- 增加视频教程等多媒体内容

## 附加说明

### 文档格式

- 使用 Markdown 格式编写
- 文件名：README.md
- 编码：UTF-8
- 换行：Unix 风格（LF）

### 特殊标记

- 使用 Badge 展示版本、状态等信息（如需要）
- 使用图标增强视觉效果（如需要）
- 使用折叠区域隐藏详细内容（如需要）

### 国际化考虑

- 主文档使用中文
- 考虑提供英文版本（README_EN.md）
- 关键术语保留英文原文

## 设计总结

本 README 设计遵循"由浅入深、循序渐进"的原则，确保不同层次的用户都能快速找到所需信息。通过清晰的结构、丰富的示例和详尽的说明，帮助用户全面理解和高效使用 QNN 日志分析技能项目。文档不仅是使用手册，更是系统设计思想的体现，为后续的功能扩展和社区贡献奠定良好基础。
本 README 设计遵循"由浅入深、循序渐进"的原则，确保不同层次的用户都能快速找到所需信息。通过清晰的结构、丰富的示例和详尽的说明，帮助用户全面理解和高效使用 QNN 日志分析技能项目。文档不仅是使用手册，更是系统设计思想的体现，为后续的功能扩展和社区贡献奠定良好基础。